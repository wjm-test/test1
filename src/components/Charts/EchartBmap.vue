<template>
  <div>
    <!-- <remote-js :js-url="'https://api.map.baidu.com/api?v=2.0&ak=ZmMCG4QP5FaX064YxPdgQq1sHLYyjKMA'" /> -->
    <div
      :id="id"
      :class="className"
    />
  </div>
</template>
<script>
import echarts from 'echarts'
import resize from './mixins/resize'
import 'echarts/extension/bmap/bmap'
import mapStyle from './bmapStyle.json'

export default {
  mixins: [resize],
  props: {
    className: {
      type: String,
      default: 'chart'
    },
    id: {
      type: String,
      default: 'chart'
    },
    width: {
      type: String,
      default: '100%'
    },
    height: {
      type: String,
      default: '500px'
    }
  },
  data() {
    return {
      house_area: '鄞州',
      house_name: '日湖花园',
      house_id: '3572',
      house_site: [
        {
          name: '日湖花园',
          value: [121.57311, 29.903405]
        }
      ],
      defaultZoom: 17,
      house_point: [121.57311, 29.903405],
      data_bus: [],
      data_work: [],
      data_hospital: [],
      data_shop: [],
      data_subway: [],
      data_school: [],
      data_svg: {
        a:
          'M0 532.48v-40.96c1.536-7.168 4.608-14.848 5.12-22.016C25.6 244.736 177.152 68.608 396.288 16.896 427.52 9.216 459.776 5.632 491.52 0h40.96c21.504 3.584 43.52 7.168 65.024 10.752 194.048 30.208 357.888 178.176 405.504 368.64 9.216 36.864 14.336 74.752 20.992 112.128v40.96c-1.536 7.168-4.096 14.848-5.12 22.016-20.992 226.816-176.64 404.48-398.848 454.656-28.672 6.656-58.368 9.728-87.552 14.848h-40.96c-7.168-1.536-14.848-4.608-22.016-5.12-224.768-20.992-400.896-172.544-452.608-391.168-7.68-31.232-11.264-63.488-16.896-95.232z m668.16 253.952c0.512 9.216 0.512 16.384 1.024 23.04 2.56 27.648 21.504 49.152 49.152 55.296 24.064 5.12 55.808-6.656 63.488-31.232 9.216-29.184 15.36-58.368 36.352-82.432 4.608-5.12 2.048-16.384 2.048-25.088v-179.2V445.44c44.544-8.704 55.296-18.944 56.32-51.712 2.048-74.24 1.024-75.776-61.44-92.16v-43.008c0-64.512-14.848-83.968-76.8-101.888-100.864-29.184-203.776-29.184-306.688-23.04-57.344 3.072-114.176 16.384-170.496 29.696-40.96 9.728-57.856 37.888-58.368 79.36v60.416c-50.176 9.216-56.32 17.92-56.32 77.312 0 45.056 9.216 56.32 56.32 65.024v27.136c0 86.016-0.512 172.544 0.512 258.56 0 13.312 4.608 30.72 13.824 38.4 13.312 11.776 16.384 23.04 16.896 39.424 1.024 31.232 27.648 56.32 57.856 57.344 31.744 1.024 59.392-24.064 62.464-55.808 0.512-7.68 1.024-14.848 1.536-23.552 104.448-0.512 207.36-0.512 312.32-0.512z M508.928 590.848H296.448c-32.256 0-33.792-1.536-33.792-32.768 0-65.536 0.512-131.072-0.512-197.12-0.512-20.992 7.168-28.672 28.16-28.672 145.92 0.512 291.84 0.512 437.248 0 19.456 0 28.16 6.656 28.16 26.624-0.512 68.096-0.512 136.192 0 204.8 0 19.456-7.68 27.648-27.648 27.136-72.704-0.512-145.92 0-219.136 0zM506.88 268.288c-37.376 0-74.752-0.512-112.128 0-19.456 0.512-30.208-5.632-29.696-27.648 0.512-20.48 9.728-26.112 28.672-26.112 77.312 0.512 154.624 0.512 231.936 0 18.944 0 28.672 5.632 28.672 26.112 0.512 21.504-10.24 28.16-29.696 27.648-39.424-0.512-78.848 0-117.76 0zM334.848 707.584c-2.56 16.384-10.24 30.208-31.232 31.744-18.944 1.024-34.816-12.288-35.84-31.232-1.024-18.944 12.8-34.304 32.256-34.816 18.944-0.512 34.304 13.312 34.816 34.304zM756.224 705.536c0.512 18.944-13.824 33.792-33.28 34.304-18.944 0.512-35.328-14.848-33.792-33.28 1.536-18.944 11.264-31.744 31.744-32.768 19.968-1.024 35.328 12.8 35.328 31.744z',
        b:
          'M746.24 1024H43.84V321.6h255.424V193.856h191.552V2.304h63.872V193.92h191.616v255.36H1001.6V1024H746.24zM299.264 385.472H107.648V960h63.872V832.384h63.872V960h63.936V385.472h-0.064z m383.04 63.808V257.664H363.136V960h95.68V832.384H586.56V960h95.744V449.28z m255.424 63.808H746.24V960h63.808V832.384h63.872V960h63.808V513.088z m-127.68 191.68h63.872v63.744h-63.872v-63.744z m0-127.744h63.872v63.872h-63.872v-63.872zM458.816 704.768H586.56v63.744H458.816v-63.744z m0-127.744H586.56v63.872H458.816v-63.872z m0-127.744H586.56v63.808H458.816V449.28z m0-127.68H586.56v63.872H458.816V321.6z m-287.36 383.168h63.872v63.744h-63.872v-63.744z m0-127.744h63.872v63.872h-63.872v-63.872z m0-127.744h63.872v63.808h-63.872V449.28z',
        c:
          'M678.4256 458.63936h-115.83488V342.81472c0-14.70976-7.35744-22.0672-22.06208-22.0672H485.37088c-3.67616 0-7.35232 0-11.0336 1.83808-7.35232 3.67616-11.02848 11.0336-11.02848 18.38592v115.82464H347.47904c-12.86656 0-20.22912 7.36256-20.22912 20.22912v56.99584c0 5.51424 1.8432 9.1904 3.68128 12.87168 3.68128 5.51424 11.0336 7.35232 18.38592 7.35232H463.3088v115.83488c0 12.87168 7.35744 20.21888 20.22912 20.21888h58.8288c3.67616 0 7.36256-1.83808 9.19552-3.67616 7.35232-7.35744 11.02848-16.54272 11.02848-27.57632v-101.13024c0-3.67616 0-3.67616 3.68128-3.67616h115.82976c9.1904 0 16.54272-7.35232 18.39104-16.5376V477.0304c0-3.67616-1.8432-7.36256-3.6864-11.0336-3.67616-5.51424-11.02848-7.35744-18.3808-7.35744zM510.08 7.68C232.61184 7.68 7.68 232.61184 7.68 510.08s224.93184 502.4 502.4 502.4 502.4-224.93184 502.4-502.4S787.54816 7.68 510.08 7.68z m293.36576 517.15584c-3.68128 29.40928-16.54272 53.31968-36.77184 75.37664l-33.09568 38.60992c-23.90016 27.58144-47.80032 53.31968-75.38176 77.22496-14.70976 12.87168-29.42464 23.89504-44.12928 36.77184-9.19552 7.35232-16.54272 14.70464-25.73312 20.21888-31.2576 20.23424-64.34816 27.58656-101.12512 22.07232-29.41952-3.68128-53.31968-16.55296-75.38176-36.77696-5.51424-5.51424-11.02848-9.1904-18.3808-14.70464-36.77184-29.4144-71.7056-62.52032-102.95808-99.28704-11.0336-14.70464-23.90528-27.59168-34.93376-42.29632-1.83808-5.51424-9.1904-14.70464-14.70976-23.88992-14.70976-22.07232-22.06208-47.80544-22.06208-77.22496 0-34.93376 12.86656-66.18624 38.61504-93.76768 5.51424-5.51424 11.02848-12.86656 14.70464-18.38592 34.93376-44.12416 75.38176-82.73408 117.66784-119.50592 12.8768-11.02848 23.90528-22.06208 36.77696-31.25248 18.38592-14.70464 40.44288-23.90528 66.18624-27.57632 44.12928-5.51424 82.73408 7.35232 115.82976 38.60992 12.87168 11.02848 25.74336 22.06208 40.448 33.09056 42.28608 36.77184 80.896 75.38176 113.99168 119.50592 5.51424 7.35744 12.87168 14.70976 18.38592 23.90016 20.21376 29.41952 27.5712 64.35328 22.05696 99.28704z',
        d:
          'M512 0c-282.88 0-512 229.12-512 512s229.12 512 512 512 512-229.12 512-512-229.12-512-512-512z m-42.24 797.866667c-2.986667 7.68-7.68 14.08-13.226667 19.626666-5.546667 5.546667-12.373333 9.813333-20.053333 13.226667s-15.786667 5.12-23.893333 5.12c-8.96 0-17.066667-1.706667-24.32-5.12-7.253333-3.413333-14.08-7.68-19.626667-13.226667-5.973333-5.546667-10.24-11.946667-13.226667-19.626666-2.986667-7.68-4.693333-15.36-4.693333-23.893334s1.706667-16.64 4.693333-23.893333c2.986667-7.68 7.68-14.08 13.226667-19.626667 5.973333-5.546667 12.373333-9.813333 19.626667-12.8s15.36-4.693333 24.32-4.693333c8.533333 0 16.64 1.706667 23.893333 4.693333 7.68 2.986667 14.08 7.253333 20.053333 12.8s10.24 11.946667 13.226667 19.626667c2.986667 7.68 4.693333 15.36 4.693333 23.893333s-1.28 16.64-4.693333 23.893334z m277.76 1.706666c-3.413333 7.68-7.68 14.08-13.226667 19.626667s-12.373333 9.813333-20.053333 13.226667-15.786667 5.12-24.32 5.12-16.64-1.706667-23.893333-5.12c-7.68-3.413333-14.08-7.68-19.626667-13.226667s-9.813333-11.946667-13.226667-19.626667c-3.413333-7.68-5.12-15.36-5.12-23.893333s1.706667-16.64 5.12-23.893333c3.413333-7.68 7.68-14.08 13.226667-19.626667s11.946667-9.813333 19.626667-12.8c7.68-2.986667 15.36-4.693333 23.893333-4.693333s16.64 1.706667 24.32 4.693333 14.506667 7.253333 20.053333 12.8 9.813333 11.946667 13.226667 19.626667c3.413333 7.68 5.12 15.36 5.12 23.893333 0 8.106667-1.706667 16.213333-5.12 23.893333z m99.84-416.853333c-1.28 3.84-4.266667 12.373333-8.533333 24.746667s-8.96 26.026667-14.506667 40.96c-5.12 14.933333-10.666667 29.866667-15.786667 44.373333s-8.96 26.026667-11.52 34.56c-5.973333 17.92-13.226667 30.293333-22.186666 37.12s-19.626667 10.24-32.853334 10.24h-349.866666l9.813333 60.16H738.133333c21.333333 0 32 8.96 32 27.306667 0 8.96-2.133333 16.64-6.4 23.04s-12.373333 9.813333-25.173333 9.813333h-349.44c-8.96 0-16.213333-2.133333-22.186667-5.973333-5.973333-3.84-11.093333-9.386667-14.933333-15.786667s-7.253333-13.226667-9.813333-20.906667-4.266667-14.506667-5.546667-21.333333c-0.426667-2.56-1.706667-8.96-3.84-19.2s-4.266667-23.04-7.253333-38.4-5.973333-32.426667-9.813334-51.2-7.253333-37.973333-10.666666-57.173333c-8.533333-44.8-17.92-94.72-28.586667-150.186667h-49.92c-6.826667 0-12.373333-1.706667-16.64-5.12-4.266667-3.413333-8.106667-7.253333-11.093333-11.946667-2.986667-4.693333-4.693333-9.813333-5.973334-14.933333-1.28-5.12-1.706667-10.24-1.706666-14.506667 0-8.96 2.986667-16.213333 8.96-22.186666 5.973333-5.973333 14.08-8.533333 24.32-8.533334h67.413333c8.96 0 16.213333 1.28 21.333333 3.84s9.386667 5.973333 12.8 9.813334c2.986667 3.84 5.546667 8.106667 6.826667 12.8 1.28 4.266667 2.56 8.106667 3.413333 11.52 0.853333 3.413333 1.706667 8.533333 2.56 14.933333s1.706667 12.8 2.56 19.626667c1.28 8.106667 2.56 16.64 3.84 25.173333h456.106667c12.373333 0 22.186667 1.706667 29.013333 5.12 6.826667 3.413333 11.946667 7.253333 14.506667 12.373333 2.986667 4.693333 4.266667 10.24 3.84 15.786667 0.853333 5.12 0 10.24-1.28 14.08z',
        e:
          'M654.506667 762.453333l115.2 149.76h-42.24L666.453333 834.133333H363.946667L302.933333 912.213333H254.72l115.2-149.76h54.613333l-36.693333 41.813334h248.746667l-36.693334-41.813334h54.613334z m-273.066667-23.893333c-54.613333 0-96.853333-41.813333-96.853333-96v-329.813333c0-54.186667 42.24-101.973333 96.853333-101.973334 0 0 78.933333-5.973333 133.546667-5.973333s127.573333 5.973333 127.573333 5.973333c48.64 0 90.88 47.786667 90.88 101.973334v329.813333c0 54.186667-42.24 96-96.853333 96H381.44zM678.4 642.56c0-23.893333-17.92-41.813333-42.24-41.813333s-42.24 17.92-42.24 41.813333 17.92 41.813333 42.24 41.813333 42.24-17.493333 42.24-41.813333z m-254.72-389.546667c0 5.973333 5.973333 12.373333 12.373333 12.373334h151.466667c5.973333 0 12.373333-5.973333 12.373333-12.373334 0-5.973333-5.973333-12.373333-12.373333-12.373333H436.053333c-6.4 0.426667-11.946667 6.4-12.373333 12.373333z m-60.586667 252.16h296.96c18.346667 0 36.693333-18.346667 36.693334-36.266666v-119.893334c0-18.346667-18.346667-36.266667-36.693334-36.266666H363.093333c-18.346667 0-36.693333 18.346667-36.693333 36.266666v119.893334c0.426667 18.346667 12.373333 36.266667 36.693333 36.266666z m24.32 179.626667c24.32 0 42.24-17.92 42.24-41.813333s-17.92-41.813333-42.24-41.813334-42.24 17.92-42.24 41.813334 17.92 41.813333 42.24 41.813333zM652.373333 68.266667H377.173333C306.346667 65.706667 238.933333 90.88 188.16 139.946667 135.68 189.44 106.666667 257.28 106.666667 329.813333v625.92l77.226666-53.76V329.813333c0-104.96 86.186667-190.72 193.28-190.72h270.08c106.24 0 193.28 85.333333 193.28 190.72v572.16l77.226667 53.76V329.813333c-0.853333-144.213333-119.466667-261.546667-265.386667-261.546666z',
        f:
          'M512 1024C229.24 1024 0 794.76 0 512S229.24 0 512 0s512 229.24 512 512-229.24 512-512 512z m344.61-607.323c17.84-10.877 60.871-19.797-3.14-46.922-73.569-29.491-221.48-83.376-286.197-109.34-36.272-17.681-57.139-9.216-96.643 6.303-66.719 24.53-192.603 69.54-268.743 97.621-58.368 21.277-54.886 37.183-0.933 62.237 80.85 37.57 243.69 95.277 277.891 107.793 34.202 12.515 59.05 12.606 93.525-2.503 34.498-15.11 84.355-34.475 239.844-96.712v92.32l-36.636 32.358 53.52 51.837 52.862-53.407-25.35-24.644V416.677zM579.88 578.15c-32.427 16.612-77.779 12.357-113.528 0-57.98-19.274-105.904-33.792-148.593-50.676v172.35s73.136 73.865 208.509 73.865c125.701 0 197.222-73.865 197.222-73.865V515.186c-55.296 22.983-105.995 47.9-143.61 62.964z'
      },
      mapStyle: mapStyle.styleJson
    }
  },
  mounted() {
    this.getData() // 定义方法
  },
  beforeDestroy() {
    if (!this.chart) {
      return
    }
    this.chart.dispose()
    this.chart = null
  },
  methods: {
    getData: function() {
      this.$http
        .get(
          'http://saturn.51vip.biz:81/data-system/api/bigScreen/house/surrounding_detail',
          {
            params: {
              // 参数
              house_id: this.house_id
            }
          }
        )
        .then(str => {
          // 请求成功后的处理函数
          const sdata = str.data.data
          for (let i = 0; i < sdata.length; i++) {
            const geoCoord = {
              name: sdata[i].name,
              value: [sdata[i].longitude, sdata[i].latitude]
            }
            if (sdata[i].type === 'bus') {
              this.data_bus.push(geoCoord)
            } else if (sdata[i].type === 'work') {
              this.data_work.push(geoCoord)
            } else if (sdata[i].type === 'hospital') {
              this.data_hospital.push(geoCoord)
            } else if (sdata[i].type === 'shop') {
              this.data_shop.push(geoCoord)
            } else if (sdata[i].type === 'subway') {
              this.data_subway.push(geoCoord)
            } else if (sdata[i].type === 'school') {
              this.data_school.push(geoCoord)
            }
          }
          this.initChart()
        })
        .catch(err => {
          // 请求失败后的处理函数
          console.log(err)
        })
    },
    changeSeris(name, symbolSize) {
      this.chart.setOption({
        series: [
          {
            name: name,
            symbolSize: symbolSize
          },
          {
            name: '公交',
            symbolSize: symbolSize
          },
          {
            name: '写字楼',
            symbolSize: symbolSize
          },
          {
            name: '医院',
            symbolSize: symbolSize
          },
          {
            name: '商场',
            symbolSize: symbolSize
          },
          {
            name: '地铁',
            symbolSize: symbolSize
          },
          {
            name: '学校',
            symbolSize: symbolSize
          }
        ]
      })
    },
    initChart() {
      this.chart = echarts.init(document.getElementById(this.id))
      const itemStyle = {
        emphasis: {
          opacity: 1
        },
        normal: {
          opacity: 0.8
        }
      }
      const option = {
        title: [
          {
            text: this.house_name,
            textStyle: {
              color: '#FB9008',
              fontSize: 42
            },
            x: 'left',
            left: 40,
            top: 20
          }
        ],
        color: [
          '#ff0000',
          '#4685c3',
          '#4bbec8',
          '#4cbe96',
          '#dbdca0',
          '#d9a156',
          '#d56a6a'
        ],
        tooltip: {
          show: true,
          position: 'top',
          padding: 10,
          backgroundColor: '#333',
          borderColor: '#777',
          borderWidth: 1,
          trigger: 'item',
          textStyle: {
            color: '#ffffff',
            fontSize: 20
          },
          formatter: '{b}'
        },
        legend: {
          orient: 'vertical',
          y: '10%',
          x: '5%',
          data: ['公交', '写字楼', '医院', '商场', '地铁', '学校'],
          textStyle: {
            color: '#333',
            fontSize: 18
          },
          itemHeight: 24
        },
        // dataset: {
        //   source: {
        //     // 提供一份数据。
        //     '日湖花园': this.house_site,
        //     '公交': this.data_bus,
        //     '写字楼': this.data_work,
        //     '医院': this.data_hospital,
        //     '商场': this.data_shop,
        //     '地铁': this.data_subway,
        //     '学校': this.data_school
        //   }
        // },
        bmap: {
          center: this.house_point,
          zoom: this.defaultZoom,
          roam: true,
          mapStyle: {}
        },
        series: [
          {
            name: this.house_name,
            type: 'effectScatter',
            coordinateSystem: 'bmap',
            data: this.house_site,
            symbolSize: 32,
            pointSize: 5,
            blurSize: 6,
            label: {
              normal: {
                show: false
              },
              emphasis: {
                show: false
              }
            },
            itemStyle: {
              emphasis: {
                borderColor: '#ff0',
                borderWidth: 1
              },
              normal: {
                opacity: 0.8
              }
            }
          },
          {
            name: '公交',
            type: 'scatter',
            coordinateSystem: 'bmap',
            data: this.data_bus,
            symbol: 'path://' + this.data_svg.a,
            symbolSize: 28,
            itemStyle: itemStyle
          },
          {
            name: '写字楼',
            type: 'scatter',
            coordinateSystem: 'bmap',
            data: this.data_work,
            symbol: 'path://' + this.data_svg.b,
            symbolSize: 28,
            itemStyle: itemStyle
          },
          {
            name: '医院',
            type: 'scatter',
            coordinateSystem: 'bmap',
            data: this.data_hospital,
            symbol: 'path://' + this.data_svg.c,
            symbolSize: 28,
            itemStyle: itemStyle
          },
          {
            name: '商场',
            type: 'scatter',
            coordinateSystem: 'bmap',
            data: this.data_shop,
            symbol: 'path://' + this.data_svg.d,
            symbolSize: 28,
            itemStyle: itemStyle
          },
          {
            name: '地铁',
            type: 'scatter',
            coordinateSystem: 'bmap',
            data: this.data_subway,
            symbol: 'path://' + this.data_svg.e,
            symbolSize: 28,
            itemStyle: itemStyle
          },
          {
            name: '学校',
            type: 'scatter',
            coordinateSystem: 'bmap',
            data: this.data_school,
            symbol: 'path://' + this.data_svg.f,
            symbolSize: 28,
            itemStyle: itemStyle
          }
        ]
      }
      this.chart.setOption(option)
      // 百度地图缩放监听事件
      this.chart.on('bmaproam', () => {
        const _options = this.chart.getOption()
        const zoom = _options.bmap[0].zoom
        if (zoom === this.defaultZoom) return
        if (zoom > 16) {
          this.stop_level = 3
          this.changeSeris(this.house_name, 26)
        } else if (zoom > 14 && zoom <= 16) {
          this.stop_level = 2
          this.changeSeris(this.house_name, 16)
        } else if (zoom <= 14) {
          this.stop_level = 1
          this.changeSeris(this.house_name, 0)
        }
        this.defaultZoom = zoom
        console.log(this.defaultZoom)
      })
    }
  }
}
</script>
<style>
.chart {
  width: 100%;
  height: calc(100vh - 84px);
}
/*去除百度地图版权*/
.anchorBL {
  display: none;
}
</style>
